<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sportic Status Tracking</title>
    <link rel="shortcut icon" href="pic_2.jpg" type="image/x-icon">
    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" 
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" 
      crossorigin="anonymous" />
  </head>
  <body>
    <h1 class="text-center mt-5">Sportic Status Tracking!!!!</h1>
    
    <!-- Add Task Button -->
    <div class="container mt-3">
      <div class="text-center">
        <button type="button" id="addTaskBtn" class="btn btn-success">
          Add Today's Task
        </button>
      </div>
    </div>
    
    <!-- Cards Container -->
    <div class="container">
      <div class="row cards-container mt-5">
        <!-- Dynamic cards will be rendered here -->
      </div>
    </div>

    <!-- Task Table -->
    <div class="container mt-5">
      <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Task</th>
            <th scope="col">Status</th>
            <th scope="col">Individuals</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic table rows will be rendered here -->
        </tbody>
      </table>
    </div>

    <!-- Add/Update Task Modal -->
    <div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editStatusModalLabel">Add Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="updateForm">
              <div class="mb-3">
                <label for="task-name" class="form-label">Task</label>
                <input
                  type="text"
                  class="form-control"
                  id="task-name"
                  placeholder="Enter Task"
                />
              </div>
              <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  placeholder="Enter Username"
                />
              </div>
              <div class="mb-3">
                <label for="task-progress" class="form-label">
                  Progress Update <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="task-progress" required>
                  <option value="">Select progress update...</option>
                  <option value="Not Started">Not Started</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button 
              type="button" 
              class="btn btn-secondary" 
              data-bs-dismiss="modal">Close</button>
            <button 
              type="button" 
              id="deleteTask" 
              class="btn btn-danger">Delete Task</button>
            <button 
              type="button" 
              id="saveStatus" 
              class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script 
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" 
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" 
      crossorigin="anonymous"></script>

    <!-- Custom Script -->
    <script>
      $(document).ready(function() {
        // Ensure the delete button is hidden initially.
        $("#deleteTask").hide();

        // Initialize tasks as an empty array if not already set.
        let tasks = JSON.parse(localStorage.getItem("tasks"));
        if (!Array.isArray(tasks)) {
          tasks = [];
          localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        // Function to render tasks in the table view.
        function renderTable() {
          const tableBody = $("table tbody");
          tableBody.empty();
          if (tasks.length === 0) {
            tableBody.append(
              "<tr><td colspan='4' class='text-center'>No tasks found</td></tr>"
            );
          } else {
            $.each(tasks, function(index, task) {
              let row = `
                <tr data-task-id="${task.id}">
                  <th scope="row">${task.id}</th>
                  <td>${task.name}</td>
                  <td class="task-status">${task.status}</td>
                  <td>${task.assigned}</td>
                </tr>`;
              tableBody.append(row);
            });
          }
        }

        // Function to render tasks in card view.
        function renderCards() {
          const cardsContainer = $(".cards-container");
          cardsContainer.empty();
          if (tasks.length === 0) {
            cardsContainer.append("<p class='text-center'>No tasks available</p>");
          } else {
            $.each(tasks, function(index, task) {
              let card = `
                <div class="col-md-4">
                  <div class="card bg-dark bg-gradient text-white mb-3">
                    <div class="card-body">
                      <h5 class="card-title">${task.name}</h5>
                      <p class="card-text">Status: <span class="task-status">${task.status}</span></p>
                      <a href="#" class="btn btn-primary status-btn" data-task-id="${task.id}">Update Status</a>
                    </div>
                  </div>
                </div>`;
              cardsContainer.append(card);
            });
          }
        }

        // Initial rendering.
        renderTable();
        renderCards();

        let currentTaskId = null;

        // "Add Task" button click: clear form, enable task name editing, set mode to addition.
        $("#addTaskBtn").click(function() {
          currentTaskId = null;
          $("#updateForm")[0].reset();
          $("#task-name").prop("readonly", false);
          $("#editStatusModalLabel").text("Add Task");
          $("#deleteTask").hide();
          $("#editStatusModal").modal("show");
        });

        // Click on an existing cardâ€™s update button: load details and disable editing of the task name.
        $(document).on("click", ".status-btn", function(e) {
          e.preventDefault();
          currentTaskId = $(this).data("task-id");
          const task = tasks.find(t => t.id === currentTaskId);
          if (task) {
            $("#editStatusModalLabel").text("Update Task");
            $("#task-name").val(task.name).prop("readonly", true);
            $("#username").val(task.assigned);
            $("#task-progress").val(task.status);
            // Show delete button when updating an existing task.
            $("#deleteTask").show();
            $("#editStatusModal").modal("show");
          }
        });

        // Save button: add new task or update existing one (without modifying task name).
        $("#saveStatus").click(function() {
          const progressVal = $("#task-progress").val();
          if (!progressVal) {
            alert("The progress update field is mandatory!");
            return;
          }
          
          const username = $("#username").val();
          
          if (currentTaskId) {
            // Update only the progress status and assigned username.
            tasks = tasks.map(task => {
              if (task.id === currentTaskId) {
                return {
                  ...task,
                  status: progressVal,
                  assigned: username
                };
              }
              return task;
            });
          } else {
            // For a new task, get the task name from the form.
            const taskName = $("#task-name").val();
            const newId = tasks.length > 0 ? tasks[tasks.length - 1].id + 1 : 1;
            const newTask = {
              id: newId,
              name: taskName,
              status: progressVal,
              assigned: username
            };
            tasks.push(newTask);
          }
          
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTable();
          renderCards();
          $("#editStatusModal").modal("hide");
        });

        // Delete button: remove the task after confirming deletion.
        $("#deleteTask").click(function() {
          if (confirm("Are you sure you want to delete this task?")) {
            tasks = tasks.filter(task => task.id !== currentTaskId);
            localStorage.setItem("tasks", JSON.stringify(tasks));
            renderTable();
            renderCards();
            $("#editStatusModal").modal("hide");
          }
        });
      });
    </script>
  </body>
</html>
